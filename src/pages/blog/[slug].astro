---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Button from '../../components/ui/Button.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({ params: { slug: post.slug }, props: { post } }));
}

const { post } = Astro.props;
const { Content } = await post.render();
const allPosts = await getCollection('blog');
const related = allPosts
  .filter((p) => p.slug !== post.slug)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 3);
---

<BaseLayout title={`${post.data.title} | BrightSide Dental Studio`} description={post.data.excerpt}>
  <div class="bg-surface-soft">
    <div class="max-w-3xl mx-auto px-4 py-10 md:py-14">
      <div class="bg-surface rounded-3xl shadow-card ring-1 ring-surface-border/70">
        <div class="px-5 py-6 md:px-8 md:py-8 space-y-6">
          <div class="flex flex-wrap items-center gap-2">
            {post.data.tags?.map((tag) => (
              <span class="inline-flex items-center gap-1 rounded-full bg-brand-50 px-3 py-1 text-xs font-medium text-ink-700 ring-1 ring-brand-100" key={tag}>
                {tag}
              </span>
            ))}
          </div>
          <div>
            <h1 class="mt-3 text-3xl font-semibold tracking-tight text-ink-900 md:text-[2.1rem]">{post.data.title}</h1>
            <p class="mt-2 text-xs font-medium uppercase tracking-wide text-ink-400">
              {post.data.date.toLocaleDateString()}
              {post.data.readingTimeMinutes && ` · ${post.data.readingTimeMinutes} min read`}
            </p>
          </div>

          <article class="prose prose-slate max-w-none text-ink-700 prose-headings:text-ink-900 prose-a:text-brand-600 prose-a:no-underline hover:prose-a:underline prose-strong:text-ink-900 prose-li:marker:text-ink-400">
            <Content />
          </article>

          <div class="flex flex-wrap gap-3">
            <Button href="/new-patients" variant="primary">Request an appointment</Button>
            <Button href="/services" variant="outline">Explore services</Button>
          </div>
        </div>
      </div>
    </div>
  </div>

  {related.length > 0 && (
    <section class="bg-surface-soft">
      <div class="mx-auto max-w-5xl px-4 py-12 md:py-16 space-y-4">
        <div class="flex items-baseline justify-between">
          <h2 class="text-2xl md:text-3xl font-heading text-ink-900">More from the blog</h2>
          <a href="/blog" class="text-sm font-semibold text-brand-600 hover:text-brand-700">View all</a>
        </div>
        <div class="grid gap-4 md:grid-cols-3">
          {related.map((item) => (
            <a
              href={`/blog/${item.slug}`}
              class="group rounded-2xl bg-surface p-5 shadow-card ring-1 ring-surface-border transition hover:-translate-y-1 hover:shadow-lg"
              key={item.id}
            >
              <p class="text-xs uppercase tracking-wide text-brand-600 font-semibold">{item.data.tags?.join(', ')}</p>
              <h3 class="text-lg font-heading text-ink-900 group-hover:text-brand-600">{item.data.title}</h3>
              <p class="text-xs text-ink-400">{item.data.date.toLocaleDateString()}</p>
              <p class="text-sm text-ink-700 mt-1 line-clamp-3">{item.data.excerpt}</p>
              <span class="text-sm font-semibold text-brand-600">Read more →</span>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}
</BaseLayout>
