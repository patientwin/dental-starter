---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Section from "../../components/ui/Section.astro";
import { getCollection, getEntryBySlug } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;
if (!slug) throw new Error("Missing blog slug");

const post = await getEntryBySlug("blog", slug);
if (!post) throw new Error(`Blog post not found for slug: ${slug}`);

const { Content } = await post.render();
const { title, date, excerpt = "", tags, featuredImage, videoUrl } = post.data;

const publishedLabel =
  date &&
  new Date(date).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
const datetimeValue = date?.toISOString?.() ?? date;
---

<BaseLayout title={title} description={excerpt}>
  <main class="bg-surface-soft">
    <Section class="pt-16 pb-20">
      <div class="mx-auto flex max-w-6xl flex-col gap-10 lg:flex-row lg:items-start">
        <article class="flex-1 rounded-3xl bg-surface p-6 shadow-card ring-1 ring-surface-border md:p-10">
          <header class="mb-6 border-b border-surface-border pb-6 space-y-4">
            <p class="text-sm font-medium uppercase tracking-wide text-brand-600">Blog</p>
            <h1 class="text-3xl font-semibold tracking-tight text-ink-900 md:text-4xl">
              {title}
            </h1>

            <div class="flex flex-wrap items-center gap-3 text-sm text-ink-500">
              {publishedLabel && (
                <time datetime={datetimeValue}>{publishedLabel}</time>
              )}

              {tags && tags.length > 0 && (
                <div class="flex flex-wrap gap-2">
                  {tags.map((tag) => (
                    <span class="rounded-full bg-surface-soft px-3 py-1 text-xs font-medium text-ink-600">
                      {tag}
                    </span>
                  ))}
                </div>
              )}
            </div>

            {excerpt && (
              <p class="max-w-2xl text-base text-ink-600">{excerpt}</p>
            )}
          </header>

          {featuredImage && (
            <div class="mb-8 overflow-hidden rounded-2xl">
              <img
                src={featuredImage}
                alt={title}
                loading="lazy"
                class="h-auto w-full object-cover"
              />
            </div>
          )}

          <div class="prose prose-slate max-w-none prose-a:text-brand-600 prose-headings:text-ink-900 prose-li:marker:text-ink-400 prose-strong:text-ink-900">
            <Content />
          </div>

          {videoUrl && (
            <div class="mt-10">
              <div class="aspect-video overflow-hidden rounded-2xl bg-black">
                <iframe
                  src={videoUrl}
                  loading="lazy"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen
                  class="h-full w-full border-0"
                  title={`Video for ${title}`}
                />
              </div>
            </div>
          )}

          <div class="mt-10 rounded-2xl bg-halo-mint/40 px-6 py-5 text-sm text-ink-800 md:flex md:items-center md:justify-between">
            <p class="font-medium">
              Ready to talk about {(title || "this treatment").toLowerCase()} or other options?
            </p>
            <div class="mt-4 flex flex-wrap gap-3 md:mt-0">
              <a
                href="/#book"
                class="inline-flex items-center justify-center rounded-full bg-brand-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-brand-700"
              >
                Request appointment
              </a>
              <a
                href="/contact"
                class="inline-flex items-center justify-center rounded-full border border-ink-200 px-4 py-2 text-sm font-medium text-ink-700 hover:bg-surface-soft"
              >
                Call or message us
              </a>
            </div>
          </div>
        </article>

        <aside class="w-full max-w-sm space-y-4 lg:sticky lg:top-28 lg:self-start">
          <div class="rounded-3xl bg-surface p-5 shadow-card ring-1 ring-surface-border">
            <h2 class="text-sm font-semibold uppercase tracking-wide text-ink-500">
              About this article
            </h2>
            <dl class="mt-3 space-y-2 text-sm text-ink-600">
              <div class="flex justify-between gap-3">
                <dt class="text-ink-500">Category</dt>
                <dd>{tags && tags.length ? tags[0] : "General"}</dd>
              </div>

              {publishedLabel && (
                <div class="flex justify-between gap-3">
                  <dt class="text-ink-500">Published</dt>
                  <dd>
                    <time datetime={datetimeValue}>{publishedLabel}</time>
                  </dd>
                </div>
              )}
            </dl>
          </div>
        </aside>
      </div>
    </Section>
  </main>
</BaseLayout>
